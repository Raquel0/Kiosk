<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Potree Viewer</title>

    <link rel="stylesheet" type="text/css" href="../build/potree/potree.css">
    <link rel="stylesheet" type="text/css" href="../libs/jquery-ui/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="../libs/perfect-scrollbar/css/perfect-scrollbar.css">
    <link rel="stylesheet" type="text/css" href="../libs/openlayers3/ol.css">
    <link rel="stylesheet" type="text/css" href="../libs/spectrum/spectrum.css">
    <link rel="stylesheet" type="text/css" href="../libs/jstree/themes/mixed/style.css">
    <link rel="stylesheet" type="text/css" href="../libs/font-awesome/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../libs/font-awesome/font-awesome.css">
    <link rel="stylesheet" type="text/css" href="../assets/css/vizcaya.css">
    
    <style>
        /*Scrollbar for hotspot controls*/
        ::-webkit-scrollbar {
            width: 9px;
        }

        ::-webkit-scrollbar-button {
            width: 8px;
            height: 2px;
        }

        ::-webkit-scrollbar-track {
            background: black;
            border: thin solid black;
            box-shadow: 0px 0px 3px black inset;
            border-radius: 12px;
        }

        ::-webkit-scrollbar-thumb {
            background: #565656;
            border: thin solid #565656;
            border-radius: 12px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #7d7d7d;
            }
    </style>

</head>

<body>
    <script src="../libs/jquery/jquery-3.1.1.min.js"></script>
    <script src="../libs/spectrum/spectrum.js"></script>
    <script src="../libs/perfect-scrollbar/js/perfect-scrollbar.jquery.js"></script>
    <script src="../libs/jquery-ui/jquery-ui.min.js"></script>
    <script src="../libs/three.js/build/three.min.js"></script>
    <script src="../libs/other/BinaryHeap.js"></script>
    <script src="../libs/tween/tween.min.js"></script>
    <script src="../libs/d3/d3.js"></script>
    <script src="../libs/proj4/proj4.js"></script>
    <script src="../libs/openlayers3/ol.js"></script>
    <script src="../libs/i18next/i18next.js"></script>
    <script src="../libs/jstree/jstree.js"></script>
    <script src="../build/potree/potree.js"></script>
    <script src="../libs/plasio/js/laslaz.js"></script>
    <script src="../main.js"></script>
    <!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
    <!-- INCLUDE SETTINGS HERE -->

    <div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
        <div id="potree_render_area"></div>
        <div id="potree_sidebar_container"> </div>

        <!--Control Icons-->
        <img id="home_icon" onclick="redirectHomeFunc()" src="../images/question.svg" title="Home" />
        <img id="question_icon" src="../images/question.svg" title="Navigation" />
        <img id="refresh_icon" onclick="refreshButton()" src="../images/refresh.svg" title="Refresh Page" />
        <img id="fullscreen_icon" onclick="toggleFullScreen()" src="../images/fullscreen.svg" title="Fullscreen" />
        <!--<img id="control_icon" src="../images/arrows.svg" title="Access Control Panel" />-->
        <!---->
        <!-- Navigation Instructions -->
        <div id="nav_panel" class="navPanel">
            <div class="navPanel-content">
                <div class="intrinsic-container intrinsic-container-16x9">
                    <img class="nav_img" src="../images/navigation.png" />
                </div>
            </div>
        </div>

        <!--Hotspots Dropup-->
        <div class="controls">
            <div class="hotspot-controls">
                <div id="prev" data-title="Previous Annotation" data-action="prev-annotation">
                    <div id="prevDiv"><img id="prevIcon" src="../images/caret-left.svg" /></div>
                </div>
                <div id="hotspots" class="hotspot-name" data-action="toggle-annotation-list"><b>Touch to Tour</b></div>
                <div id="next" data-title="Next Annotation" data-action="next-annotation">
                    <div id="nextDiv"><img id="nextIcon" src="../images/caret-right.svg" /></div>
                </div>
                <div id="lists" class="list hotspots-list visible">
                    <!--<a href="#" data-action="toggle-visibility" class="annotations-visibility"></a>-->
                    <!--<a href="#" data-action="toggle-autopilot" class="annotations-autopilot"></a>-->
                    <ul class="js-scrollable">
                        <li id="li1" class="link"><a data-hotspot-target="0" title="Grotesques"><span class="index">&sccue;</span> Grotesques</a></li>
                        <li id="li2" class="link"><a data-hotspot-target="1" title="Herm"><span class="index">&sccue;</span>Herm </a></li>
                        <li id="li3" class="link"><a data-hotspot-target="2" title="Sculptures"><span class="index">&sccue;</span> Sculptures</a></li>
                        <li id="li4" class="link"><a data-hotspot-target="3" title="Mermaids"><span class="index">&sccue;</span> Mermaids</a></li>
                    </ul>
                </div>
            </div>
        </div>

    </div>
    
    <!-- Popup 1 -->
    <div id="mypopup1" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <div class="intrinsic-container intrinsic-container-16x9">
                <iframe id="iframe1" class="iframe" src="../2017herm.html"></iframe>
            </div>
        </div>
    </div>

    <!-- Popup 2-->
    <div id="mypopup2" class="popup">
        <div class="popup-content">
            <span class="close">&times;</span>
            <div class="intrinsic-container intrinsic-container-16x9">
                <iframe id="iframe2" class="iframe" src="../mermaids.html"></iframe>
            </div>
        </div>
    </div>

    <!--    <div>
                <img id="control_panel" src="../images/Control_Panel.png" usemap="#controlPanel" />
                <map name="controlPanel">
                    <area shape="circle" coords="50,55,20,10" onclick="redirectFunc()" />
                    <area shape="circle" coords="170,55,20,10" onclick="redirectHomeFunc()" />
                    <area shape="circle" coords="110,62,25,10" onclick="potreeMerMoveUp()" />
                    <area shape="circle" coords="110,140,25,10" onclick="potreeMerMoveDown()" />
                    <area shape="circle" coords="70,105,20,10" onclick="potreeMerMoveLeft()" />
                    <area shape="circle" coords="150,105,20,10" onclick="potreeMerMoveRight()" />
                    <area shape="circle" coords="50,160,20,10" onclick="zoomIn()" />
                    <area shape="circle" coords="170,160,20,10" onclick="zoomOut()" />
                </map>
            </div>
    -->

    <script>

        // initialize page and Potree
        init();

        function init() {        

            setup();
            window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

            viewer.setEDLEnabled(false);
            viewer.setFOV(60);
            viewer.setPointBudget(5 * 1000 * 1000);
            document.title = "";

            viewer.setBackground("gradient"); // ["skybox", "gradient", "black", "white"];
            viewer.loadSettingsFromURL();

            viewer.loadGUI(() => {
                viewer.setLanguage('en');
                $("#menu_tools").next().show();
                //viewer.toggleSidebar();
            });

            viewer.setDescription(``);

            let sceneSG = new Potree.Scene();
            //let sceneSG2 = new Potree.Scene();
            //let sceneSG3 = new Potree.Scene();
            //let sceneLion = new Potree.Scene();
            viewer.setScene(sceneSG);

            /* Get camera parameters from Index page
            *****************************************************/
            function getParam(paramName) {
                var src = document.referrer;
                var srcSplit = src.split("?");
                var address = srcSplit[1];
                var paramArray = address.split('&');
                for (var i = 0; i < paramArray.length; i++) {
                    var pArr = paramArray[i].split('=');
                    if (pArr[0] == paramName)
                        return pArr[1];
                }
            }

            var x_position = parseFloat(getParam('xP'));
            var y_position = parseFloat(getParam('yP'));
            var z_position = parseFloat(getParam('zP'));
            var x_lookAt = parseFloat(getParam('xL'));
            var y_lookAt = parseFloat(getParam('yL'));
            var z_lookAt = parseFloat(getParam('zL'));

            Potree.loadPointCloud("https://s3.amazonaws.com/vizcaya/pointclouds/barge/cloud.js", "barge", function (e) {

                sceneSG.addPointCloud(e.pointcloud);
                sceneSG.view.position.set(x_position, y_position, z_position);
                sceneSG.view.lookAt(new THREE.Vector3(x_lookAt, y_lookAt, z_lookAt));

                let material = e.pointcloud.material;
                material.size = 1;
                material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

                {

                    {
                        /* Annotation: Barge's Openning Transition to
                        *****************************************************/
                        let elTitle = $(`
                                        <span>
                                            <img src="${Potree.resourcePath}/icons/i.png"
                                                name="action_set_scene"
                                                class="annotation-action-icon"
                                                style="filter: invert(1);" />
                                        </span>
                                    `);
                        elTitle.find("img[name=action_set_scene]").click((event) => {
                        });
                        elTitle.toString = () => "Barge";

                        let aAbout0 = new Potree.Annotation({
                            position: [-34.982, -18.500, -0.927],
                            title: elTitle,
                            cameraPosition: [-30.203, -7.118, 5.658],
                            cameraTarget: [-35.769, -34.984, -5.137]
                        });

                        sceneSG.annotations.add(aAbout0);
                    }

                    {
                        /* Annotation: 2nd Barge's Openning Transition to
                        *****************************************************/
                        let elTitle = $(`
                                        <span>
                                            <img src="${Potree.resourcePath}/icons/i.png"
                                                name="action_set_scene"
                                                class="annotation-action-icon"
                                                style="filter: invert(1);" />
                                        </span>
                                    `);
                        elTitle.find("img[name=action_set_scene]").click((event) => {
                        });
                        elTitle.toString = () => "Barge";

                        let aAbout10 = new Potree.Annotation({
                            position: [-43.738, -34.574, -2.621],
                            title: elTitle,
                            cameraPosition: [-45.982, -38.192, 0.534],
                            cameraTarget: [-44.171, -34.177, -0.187]
                        });

                        sceneSG.annotations.add(aAbout10);
                    }

                    {
                        /* Annotation: Herm
                        *****************************************************/
                        let elTitle = $(`<span>
                                            <img src="${Potree.resourcePath}/icons/i.png"
                                                name="action_set_scene"
                                                class="annotation-action-icon"
                                                style="filter: invert(1);" />
                                        </span>`);

                        elTitle.find("img[name=action_set_scene]").click((event) => {
                            var popup = document.getElementById('mypopup1');
                            var span = document.getElementsByClassName("close")[0];

                            popup.style.display = "block";
                            span.onclick = function () {
                                popup.style.display = "none";
                                //Reloads the Popup
                                $('#mypopup1').attr('src', '');
                                var iframe = document.getElementById('iframe1');
                                iframe.src = iframe.src;
                            }
                            window.onclick = function (event) {
                                if (event.target == popup) {
                                    popup.style.display = "none";
                                    //Reloads the Popup
                                    $('#mypopup1').attr('src', '');
                                    var iframe = document.getElementById('iframe1');
                                    iframe.src = iframe.src;
                                }
                            }
                            /*event.stopPropagation();*/
                            /*viewer.setScene(sceneSG2);*/
                        });
                        elTitle.toString = () => "HERM";

                        let aAbout1 = new Potree.Annotation({
                            position: [-45.632, -27.628, -0.686],
                            title: elTitle,
                            cameraPosition: [-47.086, -24.116, 0.709],
                            cameraTarget: [-42.272, -36.396, -2.128],
                        });

                        sceneSG.annotations.add(aAbout1);
                    }

                    {
                        /* Annotation: Sculptures
                        *****************************************************/
                        let elTitle = $(`<span>
                                            <img src="${Potree.resourcePath}/icons/i.png"
                                                name="action_set_scene"
                                                class="annotation-action-icon"
                                                style="filter: invert(1);" />
                                        </span>`);
                        elTitle.find("img[name=action_set_scene]").click((event) => {
                            var popup = document.getElementById('mypopup2');
                            var span = document.getElementsByClassName("close")[1];

                            popup.style.display = "block";
                            span.onclick = function () {
                                popup.style.display = "none";
                                //Reloads the Popup
                                $('#mypopup2').attr('src', '');
                                var iframe = document.getElementById('iframe2');
                                iframe.src = iframe.src;
                            }
                            window.onclick = function (event) {
                                if (event.target == popup) {
                                    popup.style.display = "none";
                                    //Reloads the Popup
                                    $('#mypopup2').attr('src', '');
                                    var iframe = document.getElementById('iframe2');
                                    iframe.src = iframe.src;
                                }
                            }
                            /*event.stopPropagation();*/
                            /*viewer.setScene(sceneSG4);*/
                        });
                        elTitle.toString = () => "SCULPTURES";

                        let aAbout3 = new Potree.Annotation({
                            position: [-62.707, -50.302, 1.725],
                            title: elTitle,
                            cameraPosition: [-62.962, -52.057, 2.510],
                            cameraTarget: [-62.190, -50.457, 1.970],
                        });

                        sceneSG.annotations.add(aAbout3);
                    }

                    {
                        /* Annotation: Grotesques
                        *****************************************************/
                        let elTitle = $(`
                                        <span>
                                            <img src="${Potree.resourcePath}/icons/i.png"
                                                name="action_set_scene"
                                                class="annotation-action-icon"
                                                style="filter: invert(1);" />
                                        </span>
                                    `);
                        elTitle.find("img[name=action_set_scene]").click((event) => {
                        });
                        elTitle.toString = () => "GROTESQUES";

                        let aAbout2 = new Potree.Annotation({
                            position: [-34.982, -18.500, -0.927],
                            title: elTitle,
                            cameraPosition: [-38.793, -16.289, -1.458],
                            cameraTarget: [-24.277, -32.639, -0.579],
                            description: `GROTESQUES<hr>In architecture, a grotesque is a fantastic or mythical figure used for decorative purposes. One grotesque on the west side is almost completely lost, the other seven remain intact.
                        `});

                        sceneSG.annotations.add(aAbout2);
                    }

                    {
                        /* Annotation: Mermaids
                        *****************************************************/
                        let elTitle = $(`
                                        <span>
                                            <img src="${Potree.resourcePath}/icons/i.png"
                                                name="action_set_scene"
                                                class="annotation-action-icon"
                                                style="filter: invert(1);" />
                                        </span>
                                    `);
                        elTitle.find("img[name=action_set_scene]").click((event) => {
                        });
                        elTitle.toString = () => "MERMAIDS";

                        let aAbout2 = new Potree.Annotation({
                            position: [-63.358, -51.438, -1.902],
                            title: elTitle,
                            cameraPosition: [-66.079, -52.591, -1.147],
                            cameraTarget: [-42.122, -38.767, -4.326],
                            description: `MERMAIDS<hr>Much of the original detail of the Barge Mermaids has been lost over the past century due to storms and the subtropical environmental conditions. Depictions of aquatic life, real and imagined, are found throughout Vizcaya, including a group of “Merboy” sculptures located in the Fountain Garden. 
                        `});

                        sceneSG.annotations.add(aAbout2);
                    }

                }
                setTimeout(function () {
                    sceneSG.annotations.children[0].moveHere(sceneSG.camera);
                }, 4000);
                setTimeout(function () {
                    sceneSG.annotations.children[1].moveHere(sceneSG.camera);
                }, 9000);
            });

            var timeoutID;

            function setup() {
                this.addEventListener("mousemove", resetTimer, false);
                this.addEventListener("touchstart", resetTimer, false);
                this.addEventListener("mousedown", resetTimer, false);
                this.addEventListener("mouseover", resetTimer, false);
                this.addEventListener("mouseout", resetTimer, false);
                this.addEventListener("keypress", resetTimer, false);
                this.addEventListener("DOMMouseScroll", resetTimer, false);
                this.addEventListener("mousewheel", resetTimer, false);
                this.addEventListener("touchmove", resetTimer, false);
                this.addEventListener("MSPointerMove", resetTimer, false);

                startTimer();
            }

            function startTimer() {
                timeoutID = window.setTimeout(goInactive, 300000);
            }

            function resetTimer(e) {
                window.clearTimeout(timeoutID);
                goActive();
            }

            function goInactive() {
                window.top.location.href = "../index.html";
            }

            function goActive() {
                startTimer();
            }

            /* Navigation Controls Image
            *****************************************************/
            $("#question_icon").click(function () {
                $("#nav_panel").toggle();
            });

            var navPanel = document.getElementById('nav_panel');
            navPanel.addEventListener('click', function () {
                navPanel.style.display = "none";
            });

            /* Hotspots Control Dropup
            *****************************************************/
            $("#hotspots").click(function () {
                $("#lists").toggle();
            });

            //Functions for each annotation
            function item1() {
                let scene = viewer.scene;
                scene.view.position.set(-38.793, -16.289, -1.458);
                scene.view.lookAt(new THREE.Vector3(-24.277, -32.639, -0.579));
            }
            function item2() {
                let scene = viewer.scene;
                scene.view.position.set(-47.086, -24.116, 0.709);
                scene.view.lookAt(new THREE.Vector3(-42.272, -36.396, -2.128));
            }
            function item3() {
                let scene = viewer.scene;
                scene.view.position.set(-62.962, -52.057, 2.510);
                scene.view.lookAt(new THREE.Vector3(-62.190, -50.457, 1.970));

            }
            function item4() {
                let scene = viewer.scene;
                scene.view.position.set(-66.079, -52.591, -1.147);
                scene.view.lookAt(new THREE.Vector3(-42.122, -38.767, -4.326));
            }

            //Click functions for each annotation within Hotspot Control's List
            $("#li1").click(function () {
                item1();
            });
            $("#li2").click(function () {
                item2();
            });
            $("#li3").click(function () {
                item3();
            });
            $("#li4").click(function () {
                item4();
            });

            //Functions for continuous click on Prev and Next buttons
            const functions = [];
            functions.push(item1);
            functions.push(item2);
            functions.push(item3);
            functions.push(item4);

            const length = functions.length;

            const getNextIdx = (idx = 0, length, direction) => {
                switch (direction) {
                    case 'next': return (idx + 1) % length;
                    case 'prev': return (idx == 0) && length - 1 || idx - 1;
                    default: return idx;
                }
            }

            let idx; // idx is undefined, so getNewScene will take 0 as default
            const getNewScene = (direction) => {
                idx = getNextIdx(idx, length, direction);
                var sceneFunction = functions[idx];
                return sceneFunction();
            }

            $("#prev").click(function () {
                getNewScene('prev');
            });

            $("#next").click(function () {
                getNewScene('next');
            });

            //Temp solution to hide list when a hotspot is selected
            var openLink = document.getElementById('li1');
            openLink.addEventListener('click', clickHandler, false);
            function clickHandler() {
                var submenu = document.getElementById('lists');
                submenu.style.display = 'none';
            }

            var openLink = document.getElementById('li2');
            openLink.addEventListener('click', clickHandler, false);
            function clickHandler() {
                var submenu = document.getElementById('lists');
                submenu.style.display = 'none';
            }

            var openLink = document.getElementById('li3');
            openLink.addEventListener('click', clickHandler, false);
            function clickHandler() {
                var submenu = document.getElementById('lists');
                submenu.style.display = 'none';
            }

            var openLink = document.getElementById('li4');
            openLink.addEventListener('click', clickHandler, false);
            function clickHandler() {
                var submenu = document.getElementById('lists');
                submenu.style.display = 'none';
            }

             /*{   //Annotation (Example)  
                    let Mermaids = new Potree.Annotation({
                        position: [-63.358, -51.438, -1.902],
                        title: "MERMAIDS",
                        cameraPosition: [-65.596, -53.536, -1.081],
                        cameraTarget: [-44.362, -35.946, -6.132],
                        description: `Much of the original detail of the Barge Mermaids has been lost over the past century due to storms and the subtropical environmental conditions. Depictions of aquatic life, real and imagined, are found throughout Vizcaya, including a group of “Merboy” sculptures located in the Fountain Garden. `,
                    });
                    Mermaids.domElement.off("mouseenter");
                    Mermaids.domElement.off("mouseleave");
                    Mermaids.addEventListener("click", () => {
                        Mermaids.setHighlighted(!Mermaids.isHighlighted);
                    });
                    sceneSG.annotations.add(Mermaids);
                }*/

            /*// Herm point cloud in scene 2 (Example)
                    Potree.loadPointCloud("https://s3.amazonaws.com/vizcaya/pointclouds/herm/cloud.js", "herm", function (e) {
                        sceneSG2.addPointCloud(e.pointcloud);
                        sceneSG2.view.position.set(40.480, -28.044, 52.055);
                        sceneSG2.view.lookAt(new THREE.Vector3(-1.311, -0.328, 41.852));
                        e.pointcloud.material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
                        sceneSG2.addAnnotation([7.150, -0.112, 20.413], {
                            "title": "Return to Barge",
                            "actions": [{
                                "icon": Potree.resourcePath + "/icons/goto-w.svg",
                                "onclick": function () {
                                    viewer.setScene(sceneSG);
                                }
                            }]
                        });
                    });*/

            /* Control Panel
            *****************************************************
            $("#control_icon").click(function () {
                $("#control_panel").toggle();
            });
            */

        }
    </script>

</body>
</html>